# create_financial_model.py
import pandas as pd
import openpyxl
from openpyxl import Workbook
from openpyxl.styles import Font, PatternFill, Alignment
from openpyxl.chart import LineChart, Reference

def create_financial_model():
    wb = Workbook()
    
    # Лист с финансовыми показателями
    ws_finance = wb.active
    ws_finance.title = "Финансовая модель"
    
    # Заголовки
    headers = ["Показатель", "Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек", "Итого"]
    ws_finance.append(headers)
    
    # Данные
    data = [
        ["Выручка", 1000000, 1100000, 1200000, 1150000, 1250000, 1300000, 1200000, 1350000, 1400000, 1450000, 1500000, 1550000],
        ["Себестоимость", 600000, 660000, 720000, 690000, 750000, 780000, 720000, 810000, 840000, 870000, 900000, 930000],
        ["Валовая прибыль"],
        ["Операционные расходы", 200000, 205000, 210000, 215000, 220000, 225000, 230000, 235000, 240000, 245000, 250000, 255000],
        ["Операционная прибыль"],
        ["Налоги (20%)"],
        ["Чистая прибыль"],
        ["Рентабельность (%)"],
        ["ROS (%)"]
    ]
    
    for row in data:
        ws_finance.append(row)
    
    # Добавляем формулы
    for row in range(3, 15):  # Столбцы B-N
        # Валовая прибыль = Выручка - Себестоимость
        ws_finance[f'C{row+1}'] = f'=B{row-1}-B{row}'
        # Операционная прибыль = Валовая прибыль - Операционные расходы
        ws_finance[f'E{row+1}'] = f'=C{row+1}-D{row+1}'
        # Налоги = Операционная прибыль * 20%
        ws_finance[f'F{row+1}'] = f'=E{row+1}*0.2'
        # Чистая прибыль = Операционная прибыль - Налоги
        ws_finance[f'G{row+1}'] = f'=E{row+1}-F{row+1}'
        # Рентабельность = Чистая прибыль / Выручка
        ws_finance[f'H{row+1}'] = f'=IF(B{row-1}>0,G{row+1}/B{row-1},0)'
        # ROS = Операционная прибыль / Выручка
        ws_finance[f'I{row+1}'] = f'=IF(B{row-1}>0,E{row+1}/B{row-1},0)'
    
    # Итоги по строкам
    for row in range(2, 10):
        ws_finance[f'N{row}'] = f'=SUM(B{row}:M{row})'
    
    # Форматирование
    for col in range(1, 15):
        ws_finance.cell(row=1, column=col).font = Font(bold=True)
        ws_finance.cell(row=1, column=col).fill = PatternFill(start_color="366092", end_color="366092", fill_type="solid")
        ws_finance.cell(row=1, column=col).font = Font(color="FFFFFF", bold=True)
    
    # Лист с прогнозами
    ws_forecast = wb.create_sheet("Прогнозы")
    ws_forecast.append(["Месяц", "Факт", "Прогноз", "Отклонение %"])
    
    # Сохраняем
    wb.save("templates/financial-model.xlsx")

create_financial_model()
